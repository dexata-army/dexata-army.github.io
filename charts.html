<!DOCTYPE HTML>
<html>
	<head>
		<title>Dexata - charts</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<meta name="description" content="" />
		<meta name="keywords" content="" />
		<link rel="stylesheet" href="assets/css/main.css" />
		<link rel="stylesheet" href="assets/css/pagestyle.css" />
		<link rel="stylesheet" href="assets/css/print.css" />
		<link rel="icon" type="image/svg" href="images/logo.png">
		
		<!-- Scripts -->
		<script src="assets/js/params.js"></script>
		<script src="assets/js/sleep.js"></script>
		<script src="assets/js/wallet.js"></script>
		<script src="assets/js/watchlist.js"></script>
		<script src="assets/js/apex-charts/apexcharts.min.js"></script>
		<script src="assets/js/crypto-js/crypto-js.js"></script>
		
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/jquery.dropotron.min.js"></script>
		<script src="assets/js/jquery.scrollex.min.js"></script>
		<script src="assets/js/jquery.scrolly.min.js"></script>
		
		<!-- https://printjs.crabbly.com/ -->
		<script src="assets/js/print.js"></script>
		
		<!-- Global site tag (gtag.js) - Google Analytics -->
		<script async src="https://www.googletagmanager.com/gtag/js?id=G-D70JLR4EJM"></script>
		<script>
		  window.dataLayer = window.dataLayer || [];
		  function gtag(){dataLayer.push(arguments);}
		  gtag('js', new Date());
		
		  gtag('config', 'G-D70JLR4EJM');
		</script>

		<script>
			var user = "guest";
		
			if(localStorage.getItem('username'))
				user = localStorage.getItem('username');
			else if(sessionStorage.getItem('username'))
				user = sessionStorage.getItem('username');
		
			function logout()
			{
				localStorage.removeItem('no_dexata_tabs');
				localStorage.removeItem('last_load_time');
				localStorage.removeItem('last_seen');
				localStorage.removeItem('username');
				sessionStorage.removeItem('username');
				localStorage.removeItem('password');
				sessionStorage.removeItem('password');
				//location.reload();
			}
		
			function check_for_logout(username)
			{
				sleep(2000).then(() => { 
					if(!localStorage.getItem('username') || 
						localStorage.getItem('username') != username)
						location.reload();
					else
						check_for_logout(username);
				});
			}
		
			var session_timeout_sec = localStorage.getItem(user + '-session_timeout')*60;
		
			if(session_timeout_sec != undefined && session_timeout_sec > 0)
			{
				if(sessionStorage.getItem('username') || localStorage.getItem('username'))
				{
					var curr_time = Math.round((new Date()).getTime() / 1000);
		
					//checks last page load time
					if(localStorage.getItem("last_load_time"))
					{
						if(curr_time - localStorage.getItem("last_load_time") > session_timeout_sec)
						{
							logout();
							location.reload();
						}
						else
							localStorage.setItem("last_load_time", curr_time);
					}
					else
					{
						logout();
						location.reload();
					}
				}
			}
		
			if(sessionStorage.getItem("username") && !localStorage.getItem("username"))
			{
				var curr_time = Math.round((new Date()).getTime() / 1000);
				//alert(curr_time - localStorage.getItem("last_seen"));
				if(!localStorage.getItem("last_seen") ||
				     curr_time - localStorage.getItem("last_seen") > 2)
				{
					logout();
					location.reload();
				}
				else
				{
					localStorage.setItem("no_dexata_tabs", 0);
					localStorage.setItem("username", sessionStorage.getItem("username"));
					localStorage.setItem("password", sessionStorage.getItem("password"));
				}
			}
			else if(!sessionStorage.getItem("username") && localStorage.getItem("username"))
			{
				sessionStorage.setItem("username", localStorage.getItem("username"));
				sessionStorage.setItem("password", localStorage.getItem("password"));
			}
		
			var load_host = window.location.hostname;
			if(localStorage.getItem("username"))
			{
				//updates number of dexata tabs open
				if(localStorage.getItem('no_dexata_tabs') != undefined &&
					localStorage.getItem('no_dexata_tabs') >= 0)
					localStorage.setItem('no_dexata_tabs', parseFloat(localStorage.getItem('no_dexata_tabs'))+1);
				else
					localStorage.setItem('no_dexata_tabs', 1);
		
				window.addEventListener('beforeunload', function (e) {
					if(localStorage.getItem('no_dexata_tabs'))
					{
					    localStorage.setItem('no_dexata_tabs', parseFloat(localStorage.getItem('no_dexata_tabs'))-1);
		
					    if(localStorage.getItem('no_dexata_tabs') == 0)
					    {
					    	localStorage.removeItem('no_dexata_tabs');
					    	localStorage.removeItem('username');
					    	localStorage.removeItem('password');
					    }
					}
					else
					{
						sessionStorage.removeItem('username');
						sessionStorage.removeItem('password');
					}
				});
		
				//reloads page if user has logged out
				$(document).ready(function(){
					check_for_logout(localStorage.getItem('username'));
				});
			}
		</script>
	</head>
	<body class="is-preload">
		<!-- Header -->
		<header id="header" class="alt">
			<div class="logo" style="margin-top: -25px">
				<noselect>
					<a href="index.html"><img src="images/logo.png" height="45px" style="vertical-align: middle"> Dexata</a> &nbsp; 
					<a href="search.html" title='search'><i class="fas fa-search fa-1x" style="vertical-align:middle"></i></a> 
					<a href="config.html" title='config'><i class="fas fa-cogs fa-1x" style="vertical-align:middle"></i></a> 
					<a href="manage_users.html" title='manage users'><i class="fas fa-user-cog fa-1x" style="vertical-align:middle"></i></a> 
				</noselect>
			</div>
		
			<nav id="nav">
				<ul>
					<li><a href="index.html">home</a></li>
					<li><a href="coins.html">coins</a></li>
					<li><a href="charts.html">charts</a></li>
					<li><a href="scams.html">scams</a></li>
					<li><a href="watchlist.html">watchlist</a></li>
					<li><a href="wallet.html">wallet</a></li>
					<li id="login_menu_item"></li>
				</ul>
			</nav>
		</header>

		<!-- Wrapper -->
		<div id="wrapper">
			<!-- One -->
			<section id="one" class="wrapper style1">
				<div class="inner">
					<div class="spotlights">
						<center>
							<div class="spotlight" style="max-width:500px; margin-bottom: 30px">
								<div class="content">
									<h1><i class="fas fa-chart-area fa-4x" style="vertical-align:middle"></i><br><noselect>Charts</noselect></h1>
								</div>
							</div>
		
							<div id="add_chart_spotlight" class="spotlight" style="max-width:100%; width: 250px; margin-bottom: 20px; display: none">
								<div id="add_chart_div" class="xscroll">
									<table id="add_chart_table">
										<thead>
											<tr>
												<td>
													add chart
												</td>
											</tr>
										</thead>
										<tr>
											<td>
												<select id="type_select" spellcheck="false" style="width: 100%">
													<option disabled selected hidden>type</option>
													<option value="prices">price</option>
													<option value="market_caps">market cap</option>
													<option value="total_volumes">volume</option>
												</select>
											</td>
										</tr>
										<tr>
											<td>
												<select id="range_select" spellcheck="false" style="width: 100%">
													<option disabled selected hidden>range</option>
													<option value="hour">hour</option>
													<option value="day">day</option>
													<option value="week">week</option>
													<option value="month">month</option>
													<option value="year">year</option>
													<option value="max">max</option>
												</select>
											</td>
										</tr>
										<tr>
											<td><input id="id_input" spellcheck="false" placeholder="coin"></td>
										</tr>
									</table>
									<a onclick="add_chart()"><i class="fas fa-plus fa-2x" style="margin-bottom: 10px"></i></a><br>
								</div>
							</div>
		
							<div id="charts_div">
							</div>
						</center>
					</div>
				</div>
			</section>
		</div>
		
		<script>
			var coins_data;
		
			var refresh_ms = 1000*60;
		
			var no_charts = 0;
			var chart_to_update = 0;
			var chart_id = 0;
			var chart_ids = [];
			var chart_info = {};
			var charts = {};
		
			window.addEventListener('keydown',this.keydown,false);
		
			function create_chart(chart_id, title, chart_type, chart_range, y_title, data)
			{
				var options = {
			      series: [{
			      name: 'date',
			      data: data
			    }],
			      chart: {
			      type: 'area',
			      stacked: false,
			      background: 'none',
			      height: '90%',
			      zoom: {
			        type: 'xy',
			        enabled: true,
			      },
			      toolbar: {
			        autoSelected: 'zoom'
			      }
			    },
			    colors:['#C600EB', '#E91E63', '#9C27B0'],
			    dataLabels: {
			      enabled: false
			    },
			    markers: {
			      size: 0,
			    },
			    title: {
			      text: title,
			      align: 'left',
			      textColor: '#ff1493',
			    },
			    fill: {
			      type: 'gradient',
			      gradient: {
			        shadeIntensity: 0.4,
			        inverseColors: false,
			        opacityFrom: 0.8,
			        opacityTo: 0.4,
			        stops: [0, 90, 100]
			      },
			    },
			    yaxis: {
			      labels: {
			        formatter: function (val) {
			          if(val == 0)
			          	return 0;
			          else if(val >= 1)
			          	return val.toLocaleString('en');
			          else if(val > 0 && val < 0.001)
			          	return val.toExponential(3);
			          else
			          	return val.toFixed(5);
			        },
			      },
			      tickAmount: 4,
			      title: {
			        text: y_title,
			      },
			    },
			    xaxis: {
			      type: 'datetime',
		          tickAmount: 5,
			      labels: {
			        formatter: function (val) {
			          if(chart_range == "hour" || chart_range == "day")
				      	return new Date(val).toLocaleTimeString();
				      else
				      	return new Date(val).toLocaleDateString();
			        },
			      },
			    },
			    theme: {
			    	mode: 'dark',
			    },
			    stroke: {
				    width: 2,    
				},
			    tooltip: {
			      shared: false,
			      y: {
			        formatter: function (val) {
			          return (val / 1000000).toFixed(0);
			        }
			      }
			    }
			    };
		
			    charts[chart_id] = new ApexCharts(document.querySelector("#chart_" + chart_id + "_div"), options);
			    charts[chart_id].render();
			}
		
			function fetch_chart(chart_id, chart_type, chart_range, chart_freq, y_title, coin_id, coin_name)
			{
				var data_range;
		
				if(chart_range == "hour")
					data_range = 0.041666667;
				else if(chart_range == "day")
					data_range = 1;
				else if(chart_range == "week")
					data_range = 7;
				else if(chart_range == "month")
					data_range = 30;
				else if(chart_range == "year")
					data_range = 365;
				else if(chart_range == "max")
					data_range = "max";
		
				$(document).ready(function(){
					//alert('https://api.coingecko.com/api/v3/coins/' + coin_id + '/market_chart?vs_currency=usd&days=' + data_range + '&interval=' + chart_freq);
					$.get(
						'https://api.coingecko.com/api/v3/coins/' + coin_id + '/market_chart?vs_currency=usd&days=' + data_range + '&interval=' + chart_freq,
						function(data) {
							if(charts[chart_id] != undefined)
							{
								charts[chart_id].destroy();
								document.getElementById('chart_' + chart_id + "_div").innerHTML = "";
							}
		
							if(param_map.get('width'))
								document.getElementById('chart_' + chart_id + '_spotlight').style.width = param_map.get('width') + "px";
		
							if(param_map.get('height'))
								document.getElementById('chart_' + chart_id + '_spotlight').style.height = param_map.get('height') + "px";
		
							create_chart(chart_id, coin_name, chart_type, chart_range, y_title, data[chart_type]);
					}).fail(function() {
						alert("failed to fetch chart data");
					});
				});
			}
		
			function close_chart(id)
			{
				var index = chart_ids.indexOf(parseFloat(id));
				if(index != -1)
				{
					if(charts[id] != undefined)
					{
						charts[id].destroy();
						delete charts[id];
					}
		
					document.getElementById("chart_" + id + "_spotlight").innerHTML = "";
					document.getElementById("chart_" + id + "_spotlight").style.display = "none";
		
					chart_ids.splice(index, 1);
		
					if(chart_to_update < chart_id)
						chart_to_update--;
		
					no_charts--;
				}
			}
		
			function add_chart()
			{
				var chart_type = document.getElementById('type_select').value;
				var chart_range = document.getElementById('range_select').value;
				var chart_freq;
				var y_title = $('#type_select option:selected').text();
				var coin_id;
				var coin_name;
				var coin_str = document.getElementById('id_input').value;
				var coin_str_cmpr = coin_str.toLowerCase().replace(/ /g, "").replace(/-/g, "");
		
				if(document.getElementById('type_select').value == "type")
				{
					alert("please select the type of chart you would like to add");
					return;
				}
				else if(document.getElementById('range_select').value == "range")
				{
					alert("please select the data range you would like");
					return;
				}
		
				document.getElementById('id_input').value = "";
		
				if(coin_str_cmpr == "")
				{
					alert("please specify a coin");
					return;
				}
		
				for(var i=0; i<coins_data.length; i++)
				{
					if(coins_data[i]['id'].toLowerCase().replace(/ /g, "").replace(/-/g, "") == coin_str_cmpr ||
						coins_data[i]['name'].toLowerCase().replace(/ /g, "").replace(/-/g, "") == coin_str_cmpr ||
						coins_data[i]['symbol'].toLowerCase().replace(/ /g, "").replace(/-/g, "") == coin_str_cmpr)
					{
						coin_id = coins_data[i]['id'];
						coin_name = coins_data[i]['name'];
						break;
					}
				}
		
				if(coin_id == undefined)
				{
					alert("could not find " + coin_str);
					return;
				}
		
				document.getElementById('charts_div').insertAdjacentHTML('beforeend',
					'<div id="chart_' + chart_id + '_spotlight" class="spotlight" style="width: 100%; height: 400px; min-width: 250px; max-width: 100%; min-height: 250px; max-height: 600px; margin-left: 5px; margin-right: 5px; margin-bottom: 0px; resize: both; display: inline-block; overflow: hidden"> \
						<div style="position: absolute; top: 5px; left: 10px"> \
							<a href="coin.html?id=' + coin_id + '" target=”_blank”><i class="fas fa-link fa-1x" ></i></a> \
						</div> \
						<div style="position: absolute; top: 5px; right: 10px"> \
							<a onclick="close_chart(\'' + chart_id + '\')"><i class="fas fa-window-close fa-1x" ></i></a> \
						</div> \
						<div id="chart_' + chart_id + '_div" style="width: 90%; height: 90%; padding-top: 20px; padding-left: 10px; padding-right: 10px; margin: 0 auto"> \
						</div><br> \
					</div>');
		
				if(chart_range == "hour")
					chart_freq = "minute";
				else if(chart_range == "day" || chart_range == "week")
					chart_freq = "hourly";
				else if(chart_range == "month" || chart_range == "year" || chart_range == "max")
					chart_freq = "daily";
		
				chart_info[chart_id] = [chart_type, chart_range, chart_freq, y_title, coin_id, coin_name];
				fetch_chart(chart_id, chart_type, chart_range, chart_freq, y_title, coin_id, coin_name);
				chart_ids[chart_ids.length] = chart_id;
				chart_id++;
				no_charts++;
			}
		
			function add_param_charts()
			{
				if(param_map.get('coins'))
				{
					var coins_list = param_map.get('coins').split(',');
		
					if(param_map.get('range'))
						document.getElementById('range_select').value = param_map.get('range');
					else
						document.getElementById('range_select').value = 'week';
		
					for(var i=0; i<coins_list.length; i++)
					{
						document.getElementById('id_input').value = coins_list[i];
						add_chart();
					}
				}
			}
		
			function fetch_coins_list()
			{
				$(document).ready(function(){
					$.get(
			    	    'https://api.coingecko.com/api/v3/coins/list',              
						function(data) {
							coins_data = data;
							add_param_charts();
							document.getElementById('add_chart_spotlight').style.display = "inline-block";
					}).fail(function() {
						alert("failed to fetch coins list, please refresh");
					});
				});
			}
		
			function refresh_data()
			{
				if(refresh_ms > 0)
				{
					if(no_charts > 0)
					{
						sleep(refresh_ms/no_charts).then(() => { 
							fetch_chart(chart_to_update, 
							            chart_info[chart_to_update][0], 
							            chart_info[chart_to_update][1], 
							            chart_info[chart_to_update][2], 
							            chart_info[chart_to_update][3], 
							            chart_info[chart_to_update][4], 
							            chart_info[chart_to_update][5]);
							chart_to_update = (chart_to_update+1)%no_charts;
							refresh_data();
						});
					}
					else
					{
						sleep(5000).then(() => { 
							refresh_data();
						});
					}
				}
			}
		
			function keydown(e)
			{
				var code = e.keyCode;
				
				if(document.activeElement.tagName == "INPUT")
				{
					if(code == 13)
					{
						if(document.activeElement.id == "id_input")
							add_chart();
					}
				}
			}
		
			fetch_coins_list();
			refresh_data();
		</script>

		<!-- Footer -->
		<div class="footer wrapper">
			<div class="inner" style="text-align:center">
				<noselect>
					<p>
						<a href="search.html" title='search'><i class="fas fa-search fa-2x"></i></a> &nbsp;
						<a href="coins.html" title='coins'><i class="fas fa-coins fa-2x"></i></a> &nbsp;
						<a href="charts.html" title='charts'><i class="fas fa-chart-area fa-2x"></i></a> &nbsp;
						<a href="scams.html" title='scams'><i class="fas fa-bomb fa-2x"></i></a> &nbsp;
						<a href="watchlist.html" title='watchlist'><i class="fas fa-binoculars fa-2x"></i></a> &nbsp;
						<a href="wallet.html" title='wallet tracker'><i class="fas fa-wallet fa-2x"></i></a><br>
						
						<a href="https://t.me/dexata_army" title='telegram'><i class="icon brands fa-telegram fa-2x"></i></a> &nbsp;
						<a href="https://twitter.com/dexata_army" title='twitter'><i class="icon brands fa-twitter fa-2x"></i></a> &nbsp;
						<a href="https://github.com/dexata-army" title='github'><i class="icon brands fa-github fa-2x"></i></a> &nbsp;
						<a href="config.html" title='config'><i class="fas fa-cogs fa-2x"></i></a> &nbsp;
						<a href="manage_users.html" title='manage users'><i class="fas fa-user-cog fa-2x"></i></a> &nbsp;
						<text id="login_footer_item" style="display: inline-block"><a href="login.html" title='login'><i class="fas fa-sign-in-alt fa-2x"></i></a></text>
					</p>
		
					<p style="margin-top: -30px">
						<input id="footer_search_box" placeholder="search">
					</p>
		
					<p class="copyright" style="margin-top:-20px">
						&copy;<script>document.write(new Date().getFullYear())</script> Dexata
					</p>
				</noselect>
			</div>
		</div>
		
		<script>
			window.addEventListener('keydown',this.keydown,false);
		
			function keydown(e)
			{
				var code = e.keyCode;
				
				if(document.activeElement.tagName == "INPUT")
				{
					if(code == 13)
					{
						if(document.activeElement.id == "footer_search_box" &&
							document.getElementById('footer_search_box').value != "")
						{
							window.location.href = "search.html?term=" + document.getElementById('footer_search_box').value;
						}
					}
				}
			}
		
			window.addEventListener("pageshow", function (event) {
				var historyTraversal = event.persisted || 
				                     ( typeof window.performance != "undefined" && 
				                          window.performance.navigation.type === 2 );
				if(historyTraversal &&
					sessionStorage.getItem('username') &&
					curr_time - localStorage.getItem('last_seen') > 2)
				{
					// Handle page restore.
					window.location.reload();
				}
			});
		
			window.onbeforeunload = function(){
				if(sessionStorage.getItem('username') || localStorage.getItem('username'))
						localStorage.setItem('last_seen', Math.round((new Date()).getTime() / 1000));
			};
		</script>

		<script>
			//changes login to logout on page if logged in
			if(localStorage.getItem("username"))
			{
				//document.getElementById('login_menu_item').innerHTML = "<a onclick='logout()'>logout</a>";
				//document.getElementById('login_footer_item').innerHTML = "<a onclick='logout()' title='logout'><i class='fas fa-sign-out-alt fa-2x'></i></a>";
				document.getElementById('login_menu_item').innerHTML = "<a href='logout.html?return_to=" + window.location.href.substring(window.location.href.lastIndexOf('/') + 1) + "'>logout</a>"
				document.getElementById('login_footer_item').innerHTML = "<a href='logout.html?return_to=" + window.location.href.substring(window.location.href.lastIndexOf('/') + 1) + "'><i class='fas fa-sign-out-alt fa-2x'></i></a>"
			}
			else
			{
				document.getElementById('login_menu_item').innerHTML = "<a href='login.html?return_to=" + window.location.href.substring(window.location.href.lastIndexOf('/') + 1) + "'>login</a>"
				document.getElementById('login_footer_item').innerHTML = "<a href='login.html?return_to=" + window.location.href.substring(window.location.href.lastIndexOf('/') + 1) + "'><i class='fas fa-sign-in-alt fa-2x'></i></a>"
			}
		
			//prevent autocomplete
			$(':input').on('focus', function () {
				$(this).attr('autocomplete', 'off')
			});
		</script>

		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
	</body>
</html>
